<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GR Lens Distribuidora</title>
  <meta name="description" content="Mayorista de armazones para ópticas. Registro, catálogo, carrito y pedido por WhatsApp." />
  <link rel="icon" href="logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.card{box-shadow:0 6px 18px rgba(0,0,0,.06)}</style>
</head>
<body class="bg-gray-100 text-black">
  <header class="bg-white border-b sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <a href="#inicio" class="flex items-center gap-3">
        <img src="logo.png" alt="GR Lens logo" class="h-10 w-auto rounded-sm"/>
        <span class="font-semibold tracking-tight">GR Lens Distribuidora</span>
      </a>
      <nav class="flex items-center gap-4 text-sm">
        <a href="#inicio" class="hover:underline">Inicio</a>
        <a href="#categorias" class="hover:underline">Categorías</a>
        <button id="openReg" class="hover:underline">Mi cuenta</button>
        <a href="https://wa.me/541161405627" target="_blank" class="px-3 py-1 rounded-xl bg-black text-white hover:bg-gray-900">WhatsApp</a>
      </nav>
    </div>
  </header>

  <section id="inicio" class="relative">
    <img src="banner.png" alt="Banner" class="w-full object-cover max-h-[420px]" />
    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
  </section>

  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/babel">
    const WHATSAPP_NUMBER = "541161405627";
    const CURRENCY = "ARS";
    const REGISTER_ENDPOINT = "/.netlify/functions/register";

    const CATEGORIES = [
      "metal dama","metal dama premium","metal caballero","metal caballero premium",
      "acetato dama","acetato caballero","acetato economico","acetato premium",
      "tr clip on","acetato clip on","clip on 360 grados premium","nylon dama",
      "unicity","vicrola","steffany"
    ];

    const INITIAL_PRODUCTS = [
      { id: 1,  name: "Milano 02",   sku: "MD-02",  price: 29000, stock: 8,  category: "metal dama",                material: "Metal" },
      { id: 2,  name: "Verona 01",   sku: "MDP-01", price: 42000, stock: 5,  category: "metal dama premium",        material: "Metal" },
      { id: 3,  name: "Berlin 10",   sku: "MC-10",  price: 31000, stock: 10, category: "metal caballero",           material: "Metal" },
      { id: 4,  name: "Oslo 07",     sku: "MCP-07", price: 45000, stock: 4,  category: "metal caballero premium",   material: "Metal" },
      { id: 5,  name: "Siena 21",    sku: "AD-21",  price: 33000, stock: 12, category: "acetato dama",              material: "Acetato" },
      { id: 6,  name: "Torino 14",   sku: "AC-14",  price: 33000, stock: 9,  category: "acetato caballero",         material: "Acetato" },
      { id: 7,  name: "Córdoba 03",  sku: "AE-03",  price: 25000, stock: 20, category: "acetato economico",         material: "Acetato" },
      { id: 8,  name: "Mónaco 05",   sku: "AP-05",  price: 52000, stock: 6,  category: "acetato premium",           material: "Acetato" },
      { id: 9,  name: "Seoul 11",    sku: "TRC-11", price: 38000, stock: 7,  category: "tr clip on",                material: "TR Clip On" },
      { id: 10, name: "Kyoto 08",    sku: "ACLO-08",price: 42000, stock: 5,  category: "acetato clip on",           material: "Acetato Clip On" },
      { id: 11, name: "Tokyo 360",   sku: "C360-01",price: 59000, stock: 3,  category: "clip on 360 grados premium",material: "Clip On 360" },
      { id: 12, name: "Lima 04",     sku: "NYD-04", price: 30000, stock: 11, category: "nylon dama",                material: "Nylon" },
      { id: 13, name: "Unicity U5",  sku: "UNI-05", price: 34000, stock: 9,  category: "unicity",                   material: "Acetato" },
      { id: 14, name: "Vicrola V2",  sku: "VIC-02", price: 36000, stock: 7,  category: "vicrola",                   material: "Metal" },
      { id: 15, name: "Steffany S1", sku: "STF-01", price: 37000, stock: 8,  category: "steffany",                  material: "Acetato" },
    ];

    function App(){
      const [products, setProducts] = React.useState(()=>JSON.parse(localStorage.getItem("grlens_products"))||INITIAL_PRODUCTS);
      const [cart, setCart] = React.useState(()=>JSON.parse(localStorage.getItem("grlens_cart"))||[]);
      const [search, setSearch] = React.useState("");
      const [activeCats, setActiveCats] = React.useState([]);
      const [adminOpen, setAdminOpen] = React.useState(false);

      const [user, setUser] = React.useState(()=>JSON.parse(localStorage.getItem("grlens_user"))||null);
      const [showReg, setShowReg] = React.useState(!user);
      const [reg, setReg] = React.useState({nombre:"", mail:"", zona:"", optica:""});
      const [savingReg, setSavingReg] = React.useState(false);
      const [regMsg, setRegMsg] = React.useState("");

      React.useEffect(()=>localStorage.setItem("grlens_products", JSON.stringify(products)),[products]);
      React.useEffect(()=>localStorage.setItem("grlens_cart", JSON.stringify(cart)),[cart]);
      React.useEffect(()=>{
        const btn = document.getElementById("openReg");
        if(btn){ btn.onclick = ()=> setShowReg(true); }
      },[]);

      const fmt = (n)=> new Intl.NumberFormat('es-AR',{style:'currency',currency:CURRENCY}).format(n);
      const filtered = products.filter(p=>{
        const t = (p.name+" "+p.sku).toLowerCase().includes(search.toLowerCase());
        const c = activeCats.length===0 || activeCats.includes(p.category);
        return t && c;
      });
      const subtotal = cart.reduce((s,c)=>s+c.price*c.qty,0);

      function addToCart(p){
        if(p.stock<=0) return;
        setProducts(ps=>ps.map(x=>x.id===p.id?{...x,stock:x.stock-1}:x));
        setCart(cs=>{
          const ex = cs.find(i=>i.id===p.id);
          if(ex) return cs.map(i=>i.id===p.id?{...i,qty:i.qty+1}:i);
          return [...cs,{id:p.id,name:p.name,price:p.price,sku:p.sku,material:p.material,qty:1}];
        });
      }
      function removeFromCart(item){
        setCart(cs=>{
          const ex = cs.find(i=>i.id===item.id);
          if(!ex) return cs;
          const newQty = ex.qty-1;
          setProducts(ps=>ps.map(x=>x.id===item.id?{...x,stock:x.stock+1}:x));
          if(newQty<=0) return cs.filter(i=>i.id!==item.id);
          return cs.map(i=>i.id===item.id?{...i,qty:newQty}:i);
        });
      }
      function clearCart(){
        setProducts(ps=>ps.map(p=>{
          const c = cart.find(i=>i.id===p.id);
          return c ? {...p, stock:p.stock + c.qty} : p;
        }));
        setCart([]);
      }

      async function saveRegistration(e){
        e?.preventDefault();
        setRegMsg("");
        if(!reg.nombre.trim() || !reg.mail.trim() || !reg.zona.trim() || !reg.optica.trim()){
          setRegMsg("Completá todos los campos");
          return;
        }
        try{
          setSavingReg(true);
          const res = await fetch(REGISTER_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(reg)
          });
          const data = await res.json();
          if(!res.ok){ throw new Error(data.error || "No se pudo guardar el registro"); }
          localStorage.setItem("grlens_user", JSON.stringify(reg));
          setUser(reg);
          setShowReg(false);
          setRegMsg("Guardado con éxito");
        }catch(err){
          setRegMsg("Error: " + err.message);
        }finally{
          setSavingReg(false);
        }
      }

      function orderNumber(){
        const d = new Date(); const p=n=>String(n).padStart(2,'0');
        return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+"-"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds())+"-"+Math.floor(Math.random()*900+100);
      }

      function whatsappMessage(id){
        const lines = [
          "*Pedido GR Lens Distribuidora*",
          user ? `Cliente: ${user.nombre} | Óptica: ${user.optica} | Zona: ${user.zona} | Mail: ${user.mail}` : "Cliente: (sin registrar)",
          `N° de pedido: ${id}`,
          "",
          ...cart.map(i=>`• ${i.name} (${i.sku}) x${i.qty} – ${fmt(i.price)} c/u`),
          "",
          `*Total:* ${fmt(subtotal)}`,
          "",
          "Aclaración: este sitio NO cobra online. Al recibir tu pedido por WhatsApp, te enviaremos CBU y tiempos de entrega."
        ];
        return encodeURIComponent(lines.join("\n"));
      }

      function completeOrder(){
        if(!cart.length) return;
        if(!user){ setShowReg(true); return; }
        const id = orderNumber();
        const history = JSON.parse(localStorage.getItem("grlens_orders")||"[]");
        history.push({ id, items: cart, total: subtotal, user, createdAt: new Date().toISOString() });
        localStorage.setItem("grlens_orders", JSON.stringify(history));
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${whatsappMessage(id)}`;
        window.open(url, "_blank");
        alert(`✅ Pedido finalizado con éxito\n\nN° de pedido: ${id}\nTotal: ${fmt(subtotal)}`);
        clearCart();
      }

      return (
        <div className="max-w-7xl mx-auto px-4 py-6">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div className="flex items-center gap-3">
              <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Buscar por nombre o SKU" className="w-full md:w-80 px-4 py-2 rounded-xl border bg-white"/>
              <button onClick={()=>setAdminOpen(v=>!v)} className="px-3 py-2 rounded-xl border bg-white text-sm">{adminOpen? "Cerrar admin":"Cargar/Editar stock"}</button>
            </div>
            <div className="flex items-center gap-3">
              <span className="text-sm text-gray-600">{user ? `Bienvenido, ${user.nombre} — ${user.optica}` : "Cliente no registrado"}</span>
              <button onClick={()=>setShowReg(true)} className="px-3 py-2 rounded-xl border bg-white text-sm">{user? "Editar datos":"Registrarme"}</button>
              <button onClick={completeOrder} disabled={!cart.length} className={"px-4 py-2 rounded-xl text-white text-sm "+(cart.length? "bg-emerald-600 hover:bg-emerald-700":"bg-gray-400")}>Finalizar pedido</button>
            </div>
          </div>

          <div id="categorias" className="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
            <aside className="lg:col-span-1 space-y-4">
              <div className="bg-white border rounded-xl p-4 card">
                <h2 className="font-semibold mb-2">Categorías</h2>
                <div className="space-y-2 max-h-[360px] overflow-auto pr-1">
                  {CATEGORIES.map(cat => (
                    <label key={cat} className="flex items-center gap-2 text-sm">
                      <input type="checkbox" checked={activeCats.includes(cat)} onChange={()=>setActiveCats(v=>v.includes(cat)? v.filter(x=>x!==cat):[...v,cat])} />
                      <span className="capitalize">{cat}</span>
                    </label>
                  ))}
                </div>
                <button onClick={()=>setActiveCats([])} className="mt-3 text-xs text-gray-600 underline">Limpiar filtros</button>
              </div>

              <div className="bg-white border rounded-xl p-4 card">
                <h3 className="text-sm font-semibold mb-2">Carrito</h3>
                <div className="max-h-48 overflow-auto space-y-2 pr-1">
                  {cart.length===0 && <p className="text-sm text-gray-500">Aún no hay productos.</p>}
                  {cart.map(item => (
                    <div key={item.id} className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium">{item.name} <span className="text-gray-500">({item.sku})</span></p>
                        <p className="text-xs text-gray-600">{item.material} · {fmt(item.price)}</p>
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={()=>removeFromCart(item)} className="w-6 h-6 border rounded">-</button>
                        <span className="text-sm w-6 text-center">{item.qty}</span>
                        <button onClick={()=>addToCart(products.find(p=>p.id===item.id))} className="w-6 h-6 border rounded">+</button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex items-center justify-between border-t mt-2 pt-2 text-sm">
                  <span>Total</span>
                  <span className="font-semibold">{fmt(subtotal)}</span>
                </div>
              </div>
            </aside>

            <main className="lg:col-span-3 grid sm:grid-cols-2 xl:grid-cols-3 gap-5">
              {filtered.map(p => (
                <article key={p.id} className="bg-white border rounded-2xl p-4 flex flex-col card hover:shadow-lg transition-shadow">
                  <div className="aspect-[4/3] rounded-lg bg-gradient-to-br from-gray-200 to-gray-50 mb-3 flex items-center justify-center text-gray-500">IMG</div>
                  <h3 className="font-semibold leading-tight">{p.name}</h3>
                  <p className="text-sm text-gray-600 capitalize">{p.category}</p>
                  <p className="text-xs text-gray-500">SKU: {p.sku}</p>
                  <div className="mt-auto flex items-end justify-between pt-3">
                    <div>
                      <p className="text-lg font-bold">{fmt(p.price)}</p>
                      <p className={p.stock>0? "text-emerald-600 text-xs":"text-red-600 text-xs"}>Stock: {p.stock}</p>
                    </div>
                    <button disabled={p.stock<=0} onClick={()=>addToCart(p)} className={"px-3 py-2 rounded text-sm border "+(p.stock>0? "bg-black text-white hover:bg-gray-900":"bg-gray-300 text-gray-600")}>Agregar</button>
                  </div>
                </article>
              ))}
              {filtered.length===0 && (
                <div className="col-span-full text-center text-gray-600">No hay productos que coincidan con los filtros.</div>
              )}
            </main>
          </div>

          {adminOpen && <AdminPanel products={products} setProducts={setProducts} />}

          <footer className="text-xs text-center text-gray-500 mt-10">
            Este sitio no procesa pagos. Tu pedido se envía por WhatsApp para coordinar CBU y entrega.
          </footer>

          {showReg && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
              <form className="bg-white rounded-2xl p-5 w-full max-w-md space-y-3" onSubmit={saveRegistration}>
                <h3 className="text-lg font-semibold">Registro de cliente</h3>
                <p className="text-xs text-gray-600">Completá tus datos para finalizar pedidos.</p>
                <input className="w-full px-3 py-2 border rounded-xl" placeholder="Nombre y apellido" value={reg.nombre} onChange={e=>setReg({...reg, nombre:e.target.value})} required />
                <input type="email" className="w-full px-3 py-2 border rounded-xl" placeholder="Email" value={reg.mail} onChange={e=>setReg({...reg, mail:e.target.value})} required />
                <input className="w-full px-3 py-2 border rounded-xl" placeholder="Zona" value={reg.zona} onChange={e=>setReg({...reg, zona:e.target.value})} required />
                <input className="w-full px-3 py-2 border rounded-xl" placeholder="Nombre de su óptica" value={reg.optica} onChange={e=>setReg({...reg, optica:e.target.value})} required />
                <div className="flex items-center justify-between text-xs text-gray-500"><span>{regMsg}</span>{savingReg && <span>Guardando…</span>}</div>
                <div className="flex items-center justify-end gap-2 pt-2">
                  <button type="button" onClick={()=>setShowReg(false)} className="px-3 py-2 rounded-xl border">Cerrar</button>
                  <button type="submit" className="px-3 py-2 rounded-xl bg-black text-white" disabled={savingReg}>Guardar</button>
                </div>
              </form>
            </div>
          )}
        </div>
      );
    }

    function AdminPanel({ products, setProducts }){
      const [form, setForm] = React.useState({ id:0, name:"", sku:"", price:0, stock:0, category:"metal dama", material:"" });
      const editing = form.id!==0;
      function reset(){ setForm({ id:0, name:"", sku:"", price:0, stock:0, category:"metal dama", material:"" }); }
      function save(){
        if(!form.name || !form.sku) return;
        if(editing){
          setProducts(ps=>ps.map(p=>p.id===form.id?{...form, price:Number(form.price), stock:Number(form.stock)}:p));
        }else{
          const newId = Math.max(0, ...products.map(p=>p.id)) + 1;
          setProducts(ps=>[...ps, {...form, id:newId, price:Number(form.price), stock:Number(form.stock)}]);
        }
        reset();
      }
      function del(id){ setProducts(ps=>ps.filter(p=>p.id!==id)); if(form.id===id) reset(); }
      return (
        <section className="mt-8 bg-white border rounded-2xl p-4 card">
          <h3 className="font-semibold mb-2">Cargar / Editar producto</h3>
          <div className="grid md:grid-cols-3 gap-3">
            <input className="px-3 py-2 border rounded-xl" placeholder="Nombre" value={form.name} onChange={e=>setForm(f=>({...f,name:e.target.value}))} />
            <input className="px-3 py-2 border rounded-xl" placeholder="SKU" value={form.sku} onChange={e=>setForm(f=>({...f,sku:e.target.value}))} />
            <select className="px-3 py-2 border rounded-xl" value={form.category} onChange={e=>setForm(f=>({...f,category:e.target.value}))}>
              {CATEGORIES.map(c=> <option key={c} value={c}>{c}</option>)}
            </select>
            <input className="px-3 py-2 border rounded-xl" placeholder="Material" value={form.material} onChange={e=>setForm(f=>({...f,material:e.target.value}))} />
            <input type="number" className="px-3 py-2 border rounded-xl" placeholder="Precio" value={form.price} onChange={e=>setForm(f=>({...f,price:e.target.value}))} />
            <input type="number" className="px-3 py-2 border rounded-xl" placeholder="Stock" value={form.stock} onChange={e=>setForm(f=>({...f,stock:e.target.value}))} />
          </div>
          <div className="flex gap-2 mt-3">
            <button onClick={save} className="px-3 py-2 rounded-xl bg-black text-white">{editing? "Guardar cambios":"Agregar"}</button>
            <button onClick={reset} className="px-3 py-2 rounded-xl border">Limpiar</button>
          </div>
          <div className="mt-4 grid md:grid-cols-2 gap-2 max-h-72 overflow-auto pr-1">
            {products.map(p => (
              <div key={p.id} className="flex items-center justify-between border rounded-xl p-2">
                <div className="text-sm">
                  <p className="font-medium">{p.name} <span className="text-gray-500">({p.sku})</span></p>
                  <p className="text-gray-600 capitalize">{p.category} · Stock: {p.stock} · {new Intl.NumberFormat('es-AR',{style:'currency',currency:CURRENCY}).format(p.price)}</p>
                </div>
                <div className="flex gap-2">
                  <button onClick={()=>setForm(p)} className="px-3 py-1 rounded-xl border">Editar</button>
                  <button onClick={()=>del(p.id)} className="px-3 py-1 rounded-xl border text-red-600">Eliminar</button>
                </div>
              </div>
            ))}
          </div>
        </section>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
